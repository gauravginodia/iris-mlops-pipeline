name: CI - Main Branch

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Create virtual environment and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt
          pip install dvc[gs]
      
      - name: Set up GCP credentials and authenticate
        env:
          GCP_B64: ${{ secrets.GCP_CREDENTIALS_B64 }}
        run: |
          set -e
          
          # Decode and save credentials
          echo "$GCP_B64" | base64 -d > gcp-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV
          export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json
          
          echo "âœ“ Decoded service account key"
          
          # Validate JSON
          python3 -m json.tool gcp-key.json > /dev/null && echo "âœ“ Valid JSON"
          
          # Install Google Cloud CLI
          echo "Installing Google Cloud CLI..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq google-cloud-cli
          
          # Authenticate with GCP
          echo "Authenticating with GCP..."
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project mlops-466312
          
          echo "âœ“ GCP authentication successful"
      
      - name: Configure and pull DVC data
        run: |
          source .venv/bin/activate
          
          # Verify credentials are set
          echo "Using credentials: $GOOGLE_APPLICATION_CREDENTIALS"
          
          # Configure DVC remote
          echo "Configuring DVC to use GCS credentials..."
          dvc remote modify gcsremote credentialpath $(pwd)/gcp-key.json
          
          # Pull data from DVC
          echo "Running DVC pull..."
          dvc pull -v
          
          echo "âœ“ DVC pull completed"
      
      - name: Run data validation tests
        run: |
          source .venv/bin/activate
          pytest tests/test_data_validation.py -v --tb=short
      
      - name: Run model evaluation tests
        run: |
          source .venv/bin/activate
          pytest tests/test_model_evaluation.py -v --tb=short
      
      - name: Generate test coverage report
        run: |
          source .venv/bin/activate
          pytest tests/ --cov=src --cov-report=term --cov-report=html
      
      - name: Generate model metrics
        id: metrics
        run: |
          source .venv/bin/activate
          python -c "
          import pandas as pd
          import joblib
          from sklearn.model_selection import train_test_split
          from sklearn import metrics
          
          data = pd.read_csv('data/iris.csv')
          _, test = train_test_split(data, test_size=0.4, stratify=data['species'], random_state=42)
          X_test = test[['sepal_length', 'sepal_width', 'petal_length', 'petal_width']]
          y_test = test['species']
          
          model = joblib.load('models/iris_model.joblib')
          predictions = model.predict(X_test)
          
          accuracy = metrics.accuracy_score(y_test, predictions)
          precision = metrics.precision_score(y_test, predictions, average='weighted')
          recall = metrics.recall_score(y_test, predictions, average='weighted')
          f1 = metrics.f1_score(y_test, predictions, average='weighted')
          
          print(f'Accuracy: {accuracy:.4f}')
          print(f'Precision: {precision:.4f}')
          print(f'Recall: {recall:.4f}')
          print(f'F1 Score: {f1:.4f}')
          " | tee metrics.txt
      
      - name: Generate Pipeline Summary
        if: always()
        run: |
          echo "## ðŸš€ CI/CD Pipeline Report - Main Branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          source .venv/bin/activate
          pytest tests/ --tb=no -q >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Model Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat metrics.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pipeline completed at $(date)" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
      
      - name: Upload model metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: model-metrics
          path: metrics.txt
      
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f gcp-key.json
          echo "âœ“ Cleaned up credentials"
